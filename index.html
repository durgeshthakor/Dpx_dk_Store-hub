<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DPX Store | Premium Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #050505; color: white; font-family: 'Segoe UI', sans-serif; overflow-x: hidden; }
        .glass-nav { background: rgba(5, 5, 5, 0.8); backdrop-filter: blur(15px); border-bottom: 1px solid rgba(255,255,255,0.05); }
        .card-gradient { background: linear-gradient(145deg, #111, #0a0a0a); }
        .neon-text { text-shadow: 0 0 10px rgba(139, 92, 246, 0.5); }
        
        /* Custom Loader */
        .loader { width: 48px; height: 48px; border: 5px solid #FFF; border-bottom-color: #8b5cf6; border-radius: 50%; display: inline-block; box-sizing: border-box; animation: rotation 1s linear infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="pb-20">

    <nav class="glass-nav fixed w-full top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <i class="fas fa-cube text-purple-500 text-2xl"></i>
                <h1 class="text-xl font-bold tracking-wide">DPX<span class="text-purple-500">STORE</span></h1>
            </div>
            
            <div class="flex items-center gap-4">
                <div id="premium-badge" class="hidden px-3 py-1 bg-gradient-to-r from-yellow-600 to-yellow-400 rounded-full text-black text-xs font-bold shadow-[0_0_15px_rgba(234,179,8,0.4)]">
                    <i class="fas fa-crown"></i> PREMIUM
                </div>
                <img id="user-avatar" class="w-9 h-9 rounded-full border border-gray-600 cursor-pointer">
                <button id="logout-btn" class="text-gray-400 hover:text-white"><i class="fas fa-sign-out-alt"></i></button>
            </div>
        </div>
    </nav>

    <header class="pt-32 pb-10 px-4 text-center">
        <h2 class="text-4xl md:text-5xl font-bold mb-4">Discover <span class="text-purple-500 neon-text">Next-Gen</span> Tools</h2>
        <p class="text-gray-400">Bots • Scripts • Configurations • Hosting</p>
    </header>

    <div id="products-container" class="max-w-7xl mx-auto px-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <div class="col-span-full text-center py-20"><span class="loader"></span></div>
    </div>

    <div id="modal-overlay" class="fixed inset-0 bg-black/90 backdrop-blur-md hidden z-[100] items-center justify-center p-4">
        <div class="bg-[#111] border border-gray-800 p-6 rounded-2xl w-full max-w-sm relative">
            <button onclick="closeModal()" class="absolute top-4 right-4 text-gray-500 hover:text-white"><i class="fas fa-times"></i></button>
            
            <h3 class="text-xl font-bold mb-4 text-white">Unlock Product</h3>
            
            <div class="bg-white p-4 rounded-xl mb-4 flex justify-center">
                <img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=upi://pay?pa=YOUR_UPI_ID@okaxis&pn=DPX_Store" class="w-40 h-40">
            </div>
            
            <div class="flex justify-between text-sm text-gray-400 mb-4 bg-gray-900 p-3 rounded">
                <span>Price:</span>
                <span id="modal-price" class="text-green-400 font-bold text-lg"></span>
            </div>

            <label class="block text-xs text-gray-500 mb-2">Attach Payment Proof</label>
            <input type="file" id="proof-file" class="w-full text-sm text-gray-400 bg-gray-900 rounded border border-gray-700 p-2 mb-4">
            
            <button id="confirm-payment-btn" class="w-full bg-purple-600 hover:bg-purple-700 py-3 rounded-xl font-bold transition">
                Submit Request
            </button>
            <p id="upload-msg" class="text-center text-xs mt-2 text-yellow-500"></p>
        </div>
    </div>

    <script type="module">
        import { auth, signOut, onAuthStateChanged, db, collection, getDocs, addDoc, query, orderBy, where, ref, uploadBytes, getDownloadURL, storage } from './config.js';

        let currentUser = null;
        let isPremium = false;
        let purchasedItems = [];

        // Security Check
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = "login.html"; // KICK OUT
            } else {
                currentUser = user;
                document.getElementById('user-avatar').src = user.photoURL;
                
                // Fetch User Details & Purchases
                const ordersQuery = query(collection(db, "orders"), where("userEmail", "==", user.email), where("status", "==", "approved"));
                const orderSnap = await getDocs(ordersQuery);
                purchasedItems = orderSnap.docs.map(doc => doc.data().productId);
                
                // Check Premium Status (from Firestore logic if needed, simplify here)
                // For now assuming premium logic handled in loadProducts
                loadProducts();
            }
        });

        document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));

        async function loadProducts() {
            const container = document.getElementById('products-container');
            const q = query(collection(db, "products"), orderBy("timestamp", "desc"));
            const snap = await getDocs(q);
            
            container.innerHTML = '';

            snap.forEach(doc => {
                const p = doc.data();
                const pid = doc.id;
                // Logic: Free OR Purchased OR Premium (You can add Premium logic here)
                const isUnlocked = p.type === 'free' || purchasedItems.includes(pid);
                
                const btn = isUnlocked 
                    ? `<button onclick="window.open('${p.fileUrl}')" class="w-full py-3 bg-gray-800 hover:bg-gray-700 text-white rounded-xl font-bold border border-gray-600 flex items-center justify-center gap-2"><i class="fas fa-download text-green-400"></i> Download</button>`
                    : `<button onclick="openModal('${pid}', '${p.price}', '${p.title}')" class="w-full py-3 bg-gradient-to-r from-purple-600 to-blue-600 hover:opacity-90 text-white rounded-xl font-bold flex items-center justify-center gap-2 shadow-lg shadow-purple-900/20"><i class="fas fa-lock"></i> Buy ₹${p.price}</button>`;

                const html = `
                <div class="card-gradient p-1 rounded-2xl hover:-translate-y-2 transition duration-300">
                    <div class="bg-[#0a0a0a] rounded-xl p-5 h-full flex flex-col relative overflow-hidden">
                        ${p.discount ? `<div class="absolute top-0 right-0 bg-red-600 text-xs font-bold px-3 py-1 rounded-bl-lg">-${p.discount}%</div>` : ''}
                        
                        <div class="w-12 h-12 bg-gray-800 rounded-lg flex items-center justify-center text-2xl mb-4 text-purple-400">
                            <i class="fas ${p.icon || 'fa-box'}"></i>
                        </div>

                        <h3 class="text-xl font-bold text-white mb-2">${p.title}</h3>
                        <p class="text-gray-400 text-sm mb-6 flex-grow line-clamp-2">${p.description}</p>
                        
                        <div class="mt-auto">
                            ${btn}
                        </div>
                    </div>
                </div>`;
                container.innerHTML += html;
            });
        }

        // Modal Logic
        window.openModal = (pid, price, title) => {
            const modal = document.getElementById('modal-overlay');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            document.getElementById('modal-price').innerText = `₹${price}`;
            
            document.getElementById('confirm-payment-btn').onclick = async () => {
                const file = document.getElementById('proof-file').files[0];
                if(!file) return alert("Please upload screenshot!");
                
                document.getElementById('upload-msg').innerText = "Uploading Proof...";
                
                try {
                    const storageRef = ref(storage, `proofs/${currentUser.email}_${Date.now()}`);
                    await uploadBytes(storageRef, file);
                    const url = await getDownloadURL(storageRef);
                    
                    await addDoc(collection(db, "orders"), {
                        userEmail: currentUser.email,
                        productId: pid,
                        productName: title,
                        price: price,
                        screenshotUrl: url,
                        status: "pending",
                        timestamp: new Date()
                    });
                    
                    alert("Request Sent! Admin will verify shortly.");
                    closeModal();
                } catch(err) {
                    alert("Error: " + err.message);
                }
            }
        }

        window.closeModal = () => {
            document.getElementById('modal-overlay').classList.add('hidden');
            document.getElementById('modal-overlay').classList.remove('flex');
        }
    </script>
</body>
</html>
